# CI — manual only (no auto-trigger on push/PR).
# Run manually: rwx run .rwx/ci.yml --init commit-sha=$(git rev-parse HEAD) --wait
on:
  cli:
    init:
      commit-sha: ${{ event.git.sha }}

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  # ── Clone ──────────────────────────────────────────────────────────────
  - key: code
    call: git/clone 2.0.3
    with:
      repository: https://github.com/groblegark/beads3d.git
      ref: ${{ init.commit-sha }}

  # ── Node.js toolchain ─────────────────────────────────────────────────
  - key: node
    run: |
      curl -fsSL https://deb.nodesource.com/setup_22.x | sudo bash -
      sudo apt-get -y install --no-install-recommends nodejs
      node --version
      npm --version

  # ── Install dependencies ──────────────────────────────────────────────
  - key: deps
    use: [code, node]
    run: npm ci

  # ── Build (vite production build) ─────────────────────────────────────
  - key: build
    use: deps
    run: |
      echo "Building beads3d..."
      npm run build
      echo "Build output:"
      ls -la dist/

  # ── Playwright browser install (cached by Playwright version) ─────────
  - key: browsers
    use: deps
    filter:
      - package-lock.json
    run: |
      npx playwright install --with-deps chromium

  # ── Update visual snapshots (run with --target update-snapshots) ──────
  # Generates Linux baselines and pushes them to the repo.
  - key: update-snapshots
    use: [code, build, browsers]
    timeout: 30 minutes
    run: |
      echo "Generating/updating visual test snapshots..."
      npx playwright test tests/visual.spec.js --update-snapshots --reporter=list 2>&1 || true
      echo "Snapshot files generated:"
      ls -la tests/visual.spec.js-snapshots/*-linux.png 2>/dev/null || echo "No linux snapshots found"

      # Commit and push snapshots back to repo
      git config user.email "ci@beads3d.dev"
      git config user.name "beads3d CI"
      git checkout -b update-snapshots-ci
      git add tests/visual.spec.js-snapshots/*-linux.png
      if git diff --cached --quiet; then
        echo "No new snapshots to commit."
      else
        SNAPSHOT_COUNT=$(git diff --cached --name-only | wc -l)
        git commit -m "test: add ${SNAPSHOT_COUNT} Linux visual test baselines (CI-generated)"
        git remote set-url origin "https://${GITHUB_USER}:${GHCR_TOKEN}@github.com/groblegark/beads3d.git"
        git push origin update-snapshots-ci:main
        echo "Pushed ${SNAPSHOT_COUNT} snapshots to main."
      fi
    env:
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

  # ── Tests (Playwright E2E with mock API) ──────────────────────────────
  - key: test
    use: [build, browsers]
    timeout: 30 minutes
    run: |
      echo "Running Playwright tests..."
      npx playwright test --reporter=list 2>&1 | tee test-output.txt
      echo "Test complete."
    outputs:
      artifacts:
        - key: test-results
          path: test-results/
        - key: test-output
          path: test-output.txt
